name: Build and Release Android 14 Artifacts

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android 14 build + guest image dependencies
        run: |
          set -euo pipefail
          yes | sdkmanager --licenses >/dev/null || true
          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "system-images;android-34;google_apis;x86_64"

      - name: Determine release metadata
        id: meta
        run: |
          set -euo pipefail
          BASE_VERSION_NAME=$(sed -n "s/.*versionName = \"\(.*\)\".*/\1/p" build.gradle | head -n1)
          BUILD_DATE=$(date -u +%Y%m%d)
          SECURITY_PATCH=$(date -u +%Y-%m-05)
          VERSION_NAME="${BASE_VERSION_NAME}-a14.${BUILD_DATE}.${GITHUB_RUN_NUMBER}"
          VERSION_CODE="$(date -u +%y%m%d)${GITHUB_RUN_NUMBER}"

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          else
            TAG_NAME="v${VERSION_NAME}"
          fi

          {
            echo "android_release=14"
            echo "android_sdk=34"
            echo "security_patch=${SECURITY_PATCH}"
            echo "version_name=${VERSION_NAME}"
            echo "version_code=${VERSION_CODE}"
            echo "tag_name=${TAG_NAME}"
          } >> "$GITHUB_OUTPUT"

      - name: Build debug and release artifacts
        run: |
          set -euo pipefail
          ./gradlew --no-daemon clean \
            :app:assembleDebug \
            :app:assembleRelease \
            :Bcore:assembleRelease \
            -PciVersionName="${{ steps.meta.outputs.version_name }}" \
            -PciVersionCode="${{ steps.meta.outputs.version_code }}"

      - name: Collect and package generated files
        run: |
          set -euo pipefail
          mkdir -p release-artifacts/guest-image

          find app/build/outputs/apk/debug -name '*.apk' -exec cp {} release-artifacts/ \;
          find app/build/outputs/apk/release -name '*.apk' -exec cp {} release-artifacts/ \;
          find Bcore/build/outputs/aar -name '*release.aar' -exec cp {} release-artifacts/ \;

          cat > release-artifacts/guest-image/android14-guest-image-metadata.json <<JSON
          {
            "android_release": "${{ steps.meta.outputs.android_release }}",
            "android_sdk": "${{ steps.meta.outputs.android_sdk }}",
            "security_patch": "${{ steps.meta.outputs.security_patch }}",
            "system_image": "system-images;android-34;google_apis;x86_64",
            "version_name": "${{ steps.meta.outputs.version_name }}",
            "version_code": "${{ steps.meta.outputs.version_code }}",
            "generated_at_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          JSON

          if ! compgen -G "release-artifacts/*debug*.apk" > /dev/null; then
            echo "No debug APK artifacts found." >&2
            exit 1
          fi

          if ! compgen -G "release-artifacts/*release*.apk" > /dev/null; then
            echo "No release APK artifacts found." >&2
            exit 1
          fi

          if ! compgen -G "release-artifacts/*release.aar" > /dev/null; then
            echo "No release AAR artifacts found." >&2
            exit 1
          fi

          ARCHIVE_NAME="newblackbox-android14-${{ steps.meta.outputs.version_name }}.tar.gz"
          tar -czf "${ARCHIVE_NAME}" \
            -C release-artifacts .
          mv "${ARCHIVE_NAME}" release-artifacts/

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: android14-release-artifacts
          path: release-artifacts/*

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: NewBlackbox Android 14 ${{ steps.meta.outputs.version_name }}
          files: release-artifacts/*
          generate_release_notes: true
          body: |
            Automated Android 14 release.

            - Android release: ${{ steps.meta.outputs.android_release }}
            - Android SDK: ${{ steps.meta.outputs.android_sdk }}
            - Security patch: ${{ steps.meta.outputs.security_patch }}
            - Version name: ${{ steps.meta.outputs.version_name }}
            - Version code: ${{ steps.meta.outputs.version_code }}
